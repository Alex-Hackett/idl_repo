close,/all
;defines ewdata for reading, as generated by CMF_FLUX (including header)
ewdata='/aux/pc20072b/jgroh/espectros/agcar/ewdata_fin_271ed'  
openu,1,ewdata     ; open file without writing

obsdir='/aux/pc20072b/jgroh/espectros/agcar/'
;ZE_READ_SPECTRA_COL_VEC,obsdir+'agc00jul18_100.txt',l00jul100,f00jul100,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'agc_01jun09_108.txt',l01jun108,f01jun108,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'agc01apr12_35a90.txt',lambdafuse,fluxfuse,nrec

;ZE_READ_SPECTRA_COL_VEC,obsdir+'234_narv2.txt',lambdamod,fluxmod,nrec   ;best fits so far!
;ZE_READ_SPECTRA_COL_VEC,obsdir+'373_optn.txt',lambdamod,fluxmod,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'371_withsi2.txt',lambdamod,fluxmod,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'400_optn.txt',lambdamod2,fluxmod2,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'398_optn.txt',lambdamod,fluxmod,nrec
;ZE_READ_SPECTRA_COL_VEC,obsdir+'410_optn.txt',lambdamod,fluxmod,nrec
linha=''

;finds the i number of points in ewdata
i=0
while not eof(1) do begin
readf,1,linha
if linha eq '' then begin
goto,skip1
endif
i=i+1
skip1:
endwhile
close,1


;declare arrays
lambdac=dblarr(i) & cont=lambdac & ew=lambdac & sob=strarr(i) & sobc=strarr(i)
lambdac1=0. & cont1=0. & ew1=0. & sob1='A2' 

;read lambda central, continuum intensity, EW and transition ID
ewdata_header=''
openu,1,ewdata
readf,1,ewdata_header
for k=0, i-2 do begin
readf,1,lambdac1,cont1,ew1,sob1
sob1=strsub(sob1,4,50)
lambdac[k]=lambdac1 & cont[k]=cont1 & ew[k]=ew1 & sob[k]=sob1
endfor
close,1
;
;;print ew for a range of lambdas
;for l=0, i-1 do begin
;if (lambdac[l] gt 3470) and (lambdac[l] lt 11280) and (abs(ew[l]) gt 1.00) then begin
;print,l,lambdac[l],ew[l],sob[l]
;endif
;endfor
;
;
;;final redenning in model and continuum
;minusebv=-0.47
;a=4.0
;fm_unred, lambdamod, fluxmodesc, minusebv, fluxmodescd, R_V = a
;fm_unred, lambdacont, fluxcontesc, minusebv, fluxcontescd, R_V = a

;set plot range
x1l=3680. & x1u=3900.
x2l=3900. & x2u=4180.
x3l=4300. & x3u=4500.
x4l=1080. & x4u=1980.

; plot spectrum to window
set_plot,'x'
window,0,xsize=900,ysize=400,retain=2
;hline, 5.1e-11, /DATA ; put a horizontal line for Fe V transitions
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,5],xtitle='wavelength (Angstrom)',$
ytitle='Normalized Flux',/nodata
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x1l,0,x1u,12]
plots,lambdamod,fluxmod,color=fsc_color('red',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,12]
plots,lambdamod2,fluxmod2,color=fsc_color('green',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,12]
;plots,lambdacont,(0.55*fluxcontescd+0.0e-11),color=255, noclip=0,clip=[x1l,0,x1u,12],linestyle=2
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 0.3) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],4,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
endif
endfor


window,1,xsize=900,ysize=400,retain=2
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,7],xtitle='wavelength (Angstrom)', ytitle='Normalized Flux',/nodata
plots,lambdafuse,fluxfuse,color=fsc_color('grey'), noclip=0,clip=[x2l,0,x2u,7]
plots,lambdamod,fluxmod,color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,7]
plots,lambdamod2,fluxmod2,color=fsc_color('green'), noclip=0,clip=[x2l,0,x2u,7]
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 2.00) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],6e,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
endif
endfor

;making psplots
set_plot,'ps'
device,filename='/aux/pc20072b/jgroh/temp/output_opt_2001.eps',/encapsulated,/color,bit=8,xsize=8.48,ysize=6.48,/inches
;!X.OMARGIN=[10,5]
!p.multi=[0, 1, 5, 0, 0]

;set plot range
;x1l=3680. & x1u=3900.
;x2l=3900. & x2u=4180.
;x3l=4300. & x3u=4500.
;x4l=1080. & x4u=1180.
x1l=3680. & x1u=3880.
x1bl=3880. & x1bu=4180.
x2l=4320. & x2u=4485.
x2bl=4485. & x2bu=4730.
x3l=4910. & x3u=5035.
x3cl=5029. & x3cu=5329.
x4l=5650. & x4u=5780.
x4bl=5860. & x4bu=5890.
x4cl=5901. & x4cu=6499.
x5bl=6656. & x5bu=6694.
x5dl=7045. & x5du=7080.
x5cl=8300.1 & x5cu=8850
x6al=9980. & x6au=10150
x6bl=10780. & x6bu=10980

;1st panel, 

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0.1,3.1],$
/nodata,charsize=1.5,XMARGIN=[3.5,80], YMARGIN=[2,0.5]
plots,lambdafuse,fluxfuse*1.05,color=fsc_color('grey'),noclip=0,clip=[x1l,0,x1u,13]
plots,lambdamod,fluxmod,color=fsc_color('black',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,13],linestyle=0,thick=1.5
;plots,lambdacont,(0.55*fluxcontescd+0.0e-11),color=255, noclip=0,clip=[x1l,0,x1u,13],linestyle=2
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 0.3) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,2.6,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
!p.multi[0]=!p.multi[2]

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1bl,x1bu],yrange=[0,5.5],$
/nodata,charsize=1.5,XMARGIN=[52,0.5], YMARGIN=[2,0.5]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x1bl,0,x1bu,13]
plots,lambdamod,fluxmod,color=fsc_color('black',!d.table_size-10), noclip=0,clip=[x1bl,0,x1bu,13],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x1bl) and (lambdac[l] lt x1bu) and (abs(ew[l]) gt 0.3) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'HeI+HI') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+1,4.2,'!3'+string(45B)+sobc[l],alignment=0.0,orientation=90,charsize=0.5
endif
endif
endfor
xyouts,3894,3.5,'HeI+HI',alignment=0.0,orientation=90,charsize=0.5
xyouts,3891.5,3.0,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5

;2nd panel

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,6.0],/nodata,charsize=1.5,XMARGIN=[2,70], YMARGIN=[3,0.5]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x2l,0,x2u,7]
plots,lambdamod2,fluxmod2,color=fsc_color('black'), noclip=0,clip=[x2l,0,x2u,7],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 0.30) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,4.3,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
xyouts,4347,3.5,TEXTOIDL('H\gamma'),alignment=0.0,orientation=90,charsize=0.5
xyouts,4344.5,3.0,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-1

;2nd panelb
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2bl,x2bu],yrange=[0.4,2.5],/nodata,charsize=1.5,XMARGIN=[63,0.5], YMARGIN=[3,0.5]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x2bl,0,x2bu,7]
plots,lambdamod2,fluxmod2,color=fsc_color('black'), noclip=0,clip=[x2bl,0,x2bu,7],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x2bl) and (lambdac[l] lt x2bu) and (abs(ew[l]) gt 0.30) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+1,2.0,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
xyouts,4719,2.0,TEXTOIDL('HeI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,4716.5,1.8,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5


;3rd panel a

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[4855,4869],yrange=[0,13.5],/nodata,$
charsize=1.5,XMARGIN=[3,110], YMARGIN=[3,0],xtickinterval=5.
plots,lambdafuse,fluxfuse,color=fsc_color('grey'), noclip=0,clip=[4855,0,4870,13.5]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[4855,0,4870,13],linestyle=0,thick=1.5
xyouts,4864,10.0,TEXTOIDL('H\beta'),alignment=0.0,orientation=90,charsize=0.5
xyouts,4863.5,9.0,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-2
;3rd panel b

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3l,x3u],yrange=[0,4.8],/nodata,charsize=1.5,XMARGIN=[22,80], YMARGIN=[3,0],xticks=5
plots,lambdafuse,fluxfuse,color=fsc_color('grey'), noclip=0,clip=[x3l,0,x3u,12]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x3l,0,x3u,12],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 0.1) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,4.1,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
xyouts,5023,3.1,TEXTOIDL('HeI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,5020.0,2.7,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-2

;3rd panel c

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3cl,x3cu],yrange=[0.3,2.3],/nodata,charsize=1.5,XMARGIN=[53,0.5], YMARGIN=[3,0]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'), noclip=0,clip=[x3cl,0.3,x3cu,12]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x3cl,0.3,x3cu,12],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x3cl) and (lambdac[l] lt x3cu) and (abs(ew[l]) gt 0.1) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],1.7,'!3'+string(45B)+sobc[l],alignment=0.0,orientation=90,charsize=0.5
endif
if (sobc[l] eq 'FeV') then begin
xyouts,lambdac[l],4e,'!3'+string(45B),alignment=0.0,orientation=90
endif
if(sobc[l] eq 'FeVI') then begin
xyouts,lambdac[l],5,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor


;4th panel a

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x4l,x4u],yrange=[0.5,2.0],$
/nodata,charsize=1.5,XMARGIN=[3.5,100], YMARGIN=[3,0],xtickinterval=30.
plots,lambdafuse,fluxfuse*1.03,color=fsc_color('grey'),noclip=0,clip=[x4l,0.5,x4u,7]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x4l,0.5,x4u,7],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x4l) and (lambdac[l] lt x4u) and (abs(ew[l]) gt 0.10) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,1.8,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
!p.multi[0]=!p.multi[2]-3

;4th panelb

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x4bl,x4bu],yrange=[0.3,9.0],/nodata,charsize=1.5,XMARGIN=[32,83], YMARGIN=[3,0],xticks=2
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x4bl,0.3,x4bu,9]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x4bl,0.3,x4bu,9],linestyle=0,thick=1.5
xyouts,5883,4.0,TEXTOIDL('HeI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,5881,3.5,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-3

;4th panel c

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x4cl,x4cu],yrange=[0.8,2.2],/nodata,charsize=1.5,XMARGIN=[50,0.5], YMARGIN=[3,0]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x4cl,0.8,x4cu,7]
plots,lambdamod2,fluxmod2,color=fsc_color('black'), noclip=0,clip=[x4cl,0.8,x4cu,7],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x4cl) and (lambdac[l] lt x4cu) and (abs(ew[l]) gt 0.10) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,2.0,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor


;5th panel a

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[6550,6575],yrange=[-5,80],$
/nodata,charsize=1.5,XMARGIN=[3,115], YMARGIN=[3,0],xtickinterval=15.
plots,lambdafuse,fluxfuse,color=fsc_color('grey'), noclip=0,clip=[6550,0,6575,80]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[6550,0,6575,80],linestyle=0,thick=1.5
xyouts,6569,40.0,TEXTOIDL('H\alpha'),alignment=0.0,orientation=90,charsize=0.5
xyouts,6566,35.5,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-4

;5th panel b

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x5bl,x5bu],yrange=[0.2,5.5],$
/nodata,charsize=1.5,XMARGIN=[17,101], YMARGIN=[3,0],xtickinterval=15.
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x5bl,0,x5bu,7]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x5bl,0,x5bu,7],linestyle=0,thick=1.5
xyouts,6685,3.6,TEXTOIDL('HeI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,6683,3.1,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-4

;5th panel d (has to be before c)

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x5dl,x5du],yrange=[0.5,7.0],xtickinterval=15.,/nodata,charsize=1.5,XMARGIN=[32,83], YMARGIN=[3,0],xticks=3
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x5dl,0.5,x5du,7]
plots,lambdamod,fluxmod,color=fsc_color('black'), noclip=0,clip=[x5dl,0.5,x5du,7],linestyle=0,thick=1.5
xyouts,7073,4.0,TEXTOIDL('HeI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,7071,3.5,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi[0]=!p.multi[2]-4


;5th panel c

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x5cl,x5cu],yrange=[0.5,2.6],/nodata,charsize=1.5,XMARGIN=[50,0.5], YMARGIN=[3,0]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x5cl,0.5,x5cu,7]
plots,lambdamod2,fluxmod2,color=fsc_color('black'), noclip=0,clip=[x5cl,0.5,x5cu,7],linestyle=0,thick=1.5
for l=0, i-1 do begin
if (lambdac[l] gt x5cl) and (lambdac[l] lt x5cu) and (abs(ew[l]) gt 0.10) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l]+2,2.2,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90,charsize=0.5
endif
endif
endfor
xyouts,8458,2.2,TEXTOIDL('OI'),alignment=0.0,orientation=90,charsize=0.5
xyouts,8453,2.0,'!3'+string(45B),alignment=0.0,orientation=60,charsize=0.5
!p.multi=[0, 0, 0, 0, 0]
device,/close


set_plot,'x'

end
