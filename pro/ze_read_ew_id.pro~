close,/all
;defines ewdata for reading, as generated by CMF_FLUX (without the first line)
ewdata='/home/groh/espectros/agcar/ewdata_fin_319'  
openu,1,ewdata     ; open file without writing

linha=''

;finds the i number of points in ewdata
i=0
while not eof(1) do begin
readf,1,linha
if linha eq '' then begin
goto,skip1
endif
i=i+1
skip1:
endwhile
close,1


;declare arrays
lambdac=dblarr(i) & cont=lambdac & ew=lambdac & sob=strarr(i) 

lambdac1=0. & cont1=0. & ew1=0. & sob1='A2' 

;read lambda central, continuum intensity, EW and transition ID
openu,1,ewdata
for k=0, i-1 do begin
readf,1,lambdac1,cont1,ew1,sob1
sob1=strsub(sob1,4,50)
lambdac[k]=lambdac1 & cont[k]=cont1 & ew[k]=ew1 & sob[k]=sob1
endfor
close,1

;print ew for a range of lambdas
for l=0, i-1 do begin
if (lambdac[l] gt 1260) and (lambdac[l] lt 1380) and (abs(ew[l]) gt 0.05) then begin
print,l,lambdac[l],ew[l],sob[l]
endif
endfor

flux=mrdfits('/home/groh/espectros/agcar/223_uv.fits',0,header)
obsflux=mrdfits('/home/groh/espectros/agcar/agc89dec23_swp37882_merge.fits',0,header2)
crval1=fxpar(header,'CRVAL1')
cdelt1=fxpar(header,'CDELT1')
crval2=fxpar(header2,'CRVAL1')
cdelt2=fxpar(header2,'CDELT1')
t=size(obsflux)
s=size(flux)
lambda=dblarr(s[1]) & fluxd=lambda & lambda2=dblarr(t[1])
for k=0., s[1]-1 do begin
lambda[k]=crval1 + (k*cdelt1)
endfor

for n=0., t[1]-1 do begin
lambda2[n]=crval2 + (n*cdelt2)
endfor

flux6=flux/36


;final redenning
minusebv=-0.74
a=3.4
fm_unred, lambda, 2.7*flux6, minusebv, flux6dfin, R_V = a

;set plot range
x1l=1260. & x1u=1387.
x2l=1387. & x2u=1502.
x3l=1502. & x3u=1724.
x4l=1724. & x4u=1923.



; plot spectrum
window,0,xsize=900,ysize=400,retain=2
plot,lambda2,obsflux,xstyle=1,ystyle=1,xrange=[x1l,x1u],xtitle='wavelength (Angstrom)',$
ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambda,flux6dfin,color=255, noclip=0,clip=[x1l,0,x1u,1e-11]
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 0.03) then begin
xyouts,lambdac[l],1e-11,'!3'+string(45B)+sob[l],alignment=0.5,orientation=90
endif
endfor

window,1,xsize=900,ysize=400,retain=2
plot,lambda2,obsflux,xstyle=1,ystyle=1,xrange=[x2l,x2u],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambda,flux6dfin,color=255, noclip=0,clip=[x2l,0,x2u,1e-11]
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 0.05) then begin
xyouts,lambdac[l],1e-11,'!3'+string(45B)+sob[l],alignment=0.5,orientation=90
endif
endfor

window,2,xsize=900,ysize=400,retain=2
plot,lambda2,obsflux,xstyle=1,ystyle=1,xrange=[x3l,x3u],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambda,flux6dfin,color=255, noclip=0,clip=[x3l,0,x3u,1e-11]
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 0.05) then begin
xyouts,lambdac[l],1e-11,'!3'+string(45B)+sob[l],alignment=0.5,orientation=90
endif
endfor

window,3,xsize=900,ysize=400,retain=2
plot,lambda2,obsflux,xstyle=1,ystyle=1,xrange=[x4l,x4u],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambda,flux6dfin,color=255, noclip=0,clip=[x4l,0,x4u,1e-11]
for l=0, i-1 do begin
if (lambdac[l] gt x4l) and (lambdac[l] lt x4u) and (abs(ew[l]) gt 0.05) then begin
xyouts,lambdac[l],1e-11,'!3'+string(45B)+sob[l],alignment=0.5,orientation=90
endif
endfor


end
