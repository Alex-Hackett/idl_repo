close,/all
Angstrom = '!6!sA!r!u!9 %!6!n'

;defines ewdata for reading, as generated by CMF_FLUX (without the first line)
ewdata='/aux/pc244a/jgroh/ze_models/agcar/291b/obs_ions_sep/ewdata_fin_291b' 
openu,1,ewdata     ; open file without writing

;defines observed FUSE file
;obsfuse='/home/groh/espectros/agcar/agc01may27_fuse.txt'  
;obsfuse='/home/groh/espectros/agcar/agcar_fuse_2001may27_all_idl.txt' 
obsfuse='/aux/pc244a/jgroh/espectros/agcar/agcar_fuse_2001may27_all_idl.txt' 
openu,2,obsfuse     ; open file without writing

;defines model file no abs due to H and H2
;modelnoabs='/aux/pc244a/jgroh/ze_models/agcar/343/obs_fuv/343_fuv.txt'
modelnoabs='/aux/pc244a/jgroh/espectros/agcar/369_uv.txt'
;modelnoabs='/aux/pc244a/jgroh/ze_models/agcar/291b/obs_fuv/291b_fuv_isabs2121.txt'
;modelnoabs='/home/groh/espectros/agcar/291b_fuv_.txt'
;modelnoabs='/home/groh/espectros/agcar/72_uv'  
openu,4,modelnoabs    ; open file without writing

;defines model file
;model='/aux/pc244a/jgroh/ze_models/agcar/343/obs_fuv/343_fuv_isabs2121.txt';
model='/aux/pc244a/jgroh/espectros/agcar/369_fuv_isabs2121.txt'
;model='/home/groh/espectros/agcar/291b_fuv_isabs2121.txt'  ;best, but vinf too high
;model='/home/groh/espectros/agcar/222_uv'   ; reasonable fit
;model='/home/groh/espectros/agcar/.txt'
;model='/home/groh/espectros/agcar/291c_uv.txt'
openu,3,model    ; open file without writing

;finds the z number of depth points in model file
z=0.
while not eof(3) do begin
readf,3,linha
if linha eq '' then begin
goto,skip3
endif
z=z+1.0
skip3:
endwhile
close,3

;finds the w number of depth points in model noabs file
w=0.
while not eof(4) do begin
readf,4,linha
if linha eq '' then begin
goto,skip4
endif
w=w+1.0
skip4:
endwhile
close,4

;finds the u number of depth points in input FUSE files
u=0.
while not eof(2) do begin
readf,2,linha
if linha eq '' then begin
goto,skip2
endif
u=u+1.0
skip2:
endwhile
close,2

;declare arrays
lambdamod=dblarr(z) & fluxmod=lambdamod & b=lambdamod
lambdanoabs=dblarr(w) & fluxnoabs=lambdanoabs
lambdafuse=dblarr(u) & fluxfuse=lambdafuse & c=lambdafuse
red1=dblarr(10000) & red2=red1 & red3=red1

;reads model
openu,3,model
r=0.
for k=0.,z-1 do begin
readf,3,lambdamod1,fluxmod1
if (lambdamod1 lt 1190.0) then begin 
lambdamod[k]=lambdamod1 & fluxmod[k]=fluxmod1
r=r+1.0
endif
endfor
close,3

;reads model noabs
openu,4,modelnoabs
r=0.
for k=0.,w-1 do begin
readf,4,lambdanoabs1,fluxnoabs1
if (lambdanoabs1 lt 1190.0) then begin 
lambdanoabs[k]=lambdanoabs1 & fluxnoabs[k]=fluxnoabs1
r=r+1.0
endif
endfor
close,4

;reads FUSE data
openu,2,obsfuse
for j=0.,u-1 do begin
readf,2,lambdafuse1,fluxfuse1
lambdafuse[j]=lambdafuse1 & fluxfuse[j]=fluxfuse1
endfor
close,2

;scales the model flux to 6.0 kpc (AG Car)? check input file
fluxmodesc=fluxmod/(6.0*6.0)/1.0
fluxnoabsesc=fluxnoabs/(6.0*6.0)/1.0
linha=''

;finds the i number of points in ewdata
i=0
while not eof(1) do begin
readf,1,linha
if linha eq '' then begin
goto,skip1
endif
i=i+1
skip1:
endwhile
close,1


;declare arrays
lambdac=dblarr(i) & cont=lambdac & ew=lambdac & sob=strarr(i) & sobc=strarr(i)
lambdac1=0. & cont1=0. & ew1=0. & sob1='A2' 

;read lambda central, continuum intensity, EW and transition ID
openu,1,ewdata
for k=0, i-1 do begin
readf,1,lambdac1,cont1,ew1,sob1
sob1=strsub(sob1,4,50)
lambdac[k]=lambdac1 & cont[k]=cont1 & ew[k]=ew1 & sob[k]=sob1
endfor
close,1

;print ew for a range of lambdas
set_plot,'x'
window,5
plot,lambdac,abs(ew),xrange=[900,1180],/nodata
FOR l=0, i-1 do begin
 IF (lambdac[l] gt 900) and (lambdac[l] lt 1180) and (abs(ew[l]) gt 0.2) then begin
 ;print,l,lambdac[l],ew[l],sob[l]
 pos=strpos(strtrim(sob[l],1),'(')
 sobc[l]=strmid(sob[l],2,pos+2)
  IF (sobc[l] eq '  SIII') then begin
  print,lambdac[l],ew[l],sobc[l]
  xyouts,lambdac[l],abs(ew[l]),'!3'+string(45B),alignment=0.5,orientation=90
  ENDIF
 ENDIF
ENDFOR


;final redenning in model
minusebv=-0.63
a=3.4
fm_unred, lambdamod, fluxmodesc, minusebv, fluxmodescd, R_V = a
fm_unred, lambdanoabs, fluxnoabsesc, minusebv, fluxnoabsescd, R_V = a

;set plot range
;x1l=925. & x1u=1055.
x1l=925. & x1u=1020.
x2l=1020. & x2u=1101.5
x3l=1100. & x3u=1185.
x4l=1080. & x4u=1180.

; plot spectrum to window
set_plot,'x'
!p.multi=[0, 1, 3]
window,0,xsize=1200,ysize=600,retain=2
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,0.6e-12],xtitle='wavelength (Angstrom)',$
ytitle='Flux (erg/s/cm^2/Angstrom),xcharsize=4'
plots,lambdanoabs,3.0*fluxnoabsescd,color=fsc_color('green'),linestyle=1,noclip=0,clip=[x1l,0,x1u,1.0e-12]
plots,lambdamod,3.0*fluxmodescd,color=255,noclip=0,clip=[x1l,0,x1u,1.0e-12]
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 0.011) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;if ((sobc[l] ne '  Fe2') && (sobc[l] ne '  FeIII')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
;xyouts,lambdac[l],0.9e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
;endif
if (sobc[l] eq '  CrIII') then begin
xyouts,lambdac[l],0.7e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  MnIII') then begin
xyouts,lambdac[l],0.5e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,0.17e-11],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom),xcharsize=2'
plots,lambdanoabs-0.07,1.9*fluxnoabsescd,color=fsc_color('green'),linestyle=1, noclip=0,clip=[x2l,0,x2u,3.0e-12]
plots,lambdamod-0.07,1.9*fluxmodescd,color=255, noclip=0,clip=[x2l,0,x2u,3.0e-12]
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 0.4) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;xyouts,lambdac[l],1.6e-12,'!3'+string(45B)+sobc[l],aligment=0.5,orientation=90
endif
endfor


plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3l,x3u],yrange=[0,0.45e-11],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom),xcharsize=2'
plots,lambdanoabs-0.07,1.75*fluxnoabsescd,color=fsc_color('green'),linestyle=1, noclip=0,clip=[x3l,0,x3u,4.5e-12]
plots,lambdamod-0.07,1.75*fluxmodescd,color=255, noclip=0,clip=[x3l,0,x3u,4.6e-12]
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 0.01) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;xyouts,lambdac[l],4.0e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq '  CrIII') then begin
xyouts,lambdac[l],4e-12,'!3'+string(45B),alignment=0.5,orientation=90
;endif
if(sobc[l] eq '  MnIII') then begin
xyouts,lambdac[l],5e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor


;making psplots
set_plot,'ps'

device,/close

device,filename='/aux/pc244a/jgroh/temp/output_fuse_tes.eps',/encapsulated,/color,bit=8,xsize=8.48,ysize=6.48,/inches

plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l-2,x1u+2],yrange=[0,6.0e-13],ytitle='Flux (erg/s/cm!E2!N/'+Angstrom+')',xcharsize=2.0,ycharsize=2.0,thick=1.8,xthick=1.8,ythick=1.8,$
/nodata,POSITION=[0.11,0.72,0.99,0.99]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x1l,0,x1u,6.0e-11]
plots,lambdanoabs,3.0*fluxnoabsescd,color=fsc_color('red'),linestyle=1,noclip=0,clip=[x1l,0,x1u,6.0e-13]
plots,lambdamod,3.0*fluxmodescd,color=fsc_color('purple'),noclip=0,clip=[x1l,0,x1u,6.0e-13]
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 0.1) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;if ((sobc[l] ne '  Fe2') && (sobc[l] ne '  FeIII')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
;xyouts,lambdac[l],0.9e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
;endif
if (sobc[l] eq '  CrIII') then begin
;xyouts,lambdac[l],0.7e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  FeIII') then begin
;xyouts,lambdac[l],0.5e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor

;putting labels on the first panel
plots, [930,934],[5.3e-13,5.3e-13],color=fsc_color('grey')
xyouts,935,5.1e-13,'AG Car FUSE obs. 2001 May',alignment=0,orientation=0
plots, [930,934],[4.5e-13,4.5e-13],color=fsc_color('red'),linestyle=1
xyouts,935,4.3e-13,'CMFGEN model no IS abs.',alignment=0,orientation=0
plots, [930,934],[3.7e-13,3.7e-13],color=fsc_color('purple')
xyouts,935,3.5e-13,'CMFGEN model + IS abs. (N!IH!N=10!E21!N cm!E-2!N, N!IH2!N=10!E21!N cm!E-2!N)',alignment=0,orientation=0


plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l-1,x2u+1],yrange=[0,0.17e-11],xcharsize=2.0,ycharsize=2.0,$
thick=1.8,ytitle='Flux (erg/s/cm!E2!N/'+Angstrom+')',xthick=1.8,ythick=1.8,/nodata,POSITION=[0.126,0.40,0.99,0.67]
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x2l,0,x2u,1.7e-12]
plots,lambdanoabs-0.07,1.9*fluxnoabsescd,color=fsc_color('red'),linestyle=1, noclip=0,clip=[x2l,0,x2u,1.7e-12]
plots,lambdamod-0.07,1.9*fluxmodescd,color=fsc_color('purple'), noclip=0,clip=[x2l,0,x2u,1.7e-12]
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 0.2) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;xyouts,lambdac[l],1.6e-12,'!3'+string(45B)+sobc[l],aligment=0.5,orientation=90
endif
endfor



plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3l-1,x3u+1],yrange=[0,0.45e-11],xtitle='Wavelength ('+Angstrom+')',$
ytitle='Flux (erg/s/cm!E2!N/'+Angstrom+')',thick=1.8,xthick=1.8,ythick=1.8,xcharsize=2.0,ycharsize=2.0,POSITION=[0.11,0.08,0.99,0.35],/nodata
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x3l,0,x3u,4.5e-12]
plots,lambdanoabs-0.07,1.75*fluxnoabsescd,color=fsc_color('red'),linestyle=1, noclip=0,clip=[x3l,0,x3u,4.5e-12]
plots,lambdamod-0.07,1.75*fluxmodescd,color=fsc_color('purple'), noclip=0,clip=[x3l,0,x3u,4.5e-12]
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 0.2) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
;xyouts,lambdac[l],4.0e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
endfor




!p.multi=[0, 0, 0, 0, 0]
device,/close

set_plot,'x'

end
