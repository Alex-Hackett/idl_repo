PRO READ_SPECTRA_COL_VEC,file,lambda,flux

data = READ_ASCII(file)
lambda=data.field1[0,*]
flux=data.field1[1,*]

END
;--------------------------------------------------------------------------------------------------------------------------

Angstrom = '!6!sA!r!u!9 %!6!n'
close,/all
;defines ewdata for reading, as generated by CMF_FLUX (including header)
;ewdata='/aux/pc244a/jgroh/espectros/agcar/ewdata_fin_271ed'  
ewdata='/aux/pc20117a/jgroh/cmfgen_models/agcar/362/obscont/EWDATA'
openu,1,ewdata     ; open file without writing

red1=dblarr(10000) & red2=red1 & red3=red1

;defining observations
obs86jun1='/aux/pc244a/jgroh/espectros/agcar/agc86jun18_all.txt'
obs87jan1='/aux/pc244a/jgroh/espectros/agcar/agc87jan00_58.txt'
obs87jan2='/aux/pc244a/jgroh/espectros/agcar/agc87jan05_66_new_es.txt'
obs87jun1='/aux/pc244a/jgroh/espectros/agcar/agc87jun10_39.txt'
obs87jun2='/aux/pc244a/jgroh/espectros/agcar/agc87jun10_66_new_es.txt'

;defining models
model223narv='/aux/pc244a/jgroh/espectros/agcar/223_narv2.txt'
model362narv='/aux/pc244a/jgroh/espectros/agcar/362_narv2.txt'  
model348narv='/aux/pc244a/jgroh/espectros/agcar/348_cpnv_optn.txt'

;reading observations
;READ_SPECTRA_COL_VEC, obs86jun1,lambda86jun1,flux86jun1
;READ_SPECTRA_COL_VEC, obs87jan1,lambda87jan1,flux87jan1
;READ_SPECTRA_COL_VEC, obs87jan2,lambda87jan2,flux87jan2
;READ_SPECTRA_COL_VEC, obs87jun1,lambda87jun1,flux87jun1
;READ_SPECTRA_COL_VEC, obs87jun2,lambda87jun2,flux87jun2

;reading models
;READ_SPECTRA_COL_VEC,model223narv,l223narv,f223narv
;READ_SPECTRA_COL_VEC,model362narv,l362narv,f362narv


linha=''

;finds the i number of points in ewdata
i=0
while not eof(1) do begin
readf,1,linha
if linha eq '' then begin
goto,skip1
endif
i=i+1
skip1:
endwhile
close,1


;declare arrays
lambdac=dblarr(i) & cont=lambdac & ew=lambdac & sob=strarr(i) & sobc=strarr(i)
lambdac1=0. & cont1=0. & ew1=0. & sob1='A2' 

;read lambda central, continuum intensity, EW and transition ID
ewdata_header=''
openu,1,ewdata
readf,1,ewdata_header
for k=0, i-2 do begin
readf,1,lambdac1,cont1,ew1,sob1
sob1=strsub(sob1,4,50)
lambdac[k]=lambdac1 & cont[k]=cont1 & ew[k]=ew1 & sob[k]=sob1
endfor
close,1

;print ew for a range of lambdas
;for l=0, i-1 do begin
;if (lambdac[l] gt 3470) and (lambdac[l] lt 11280) and (abs(ew[l]) gt 1.00) then begin
;print,l,lambdac[l],ew[l],sob[l]
;endif
;endfor


;final redenning in model and continuum
;minusebv=-0.47
;a=4.0
;fm_unred, lambdamod, fluxmodesc, minusebv, fluxmodescd, R_V = a
;fm_unred, lambdacont, fluxcontesc, minusebv, fluxcontescd, R_V = a

;set plot range
x1l=5865. & x1u=5887.
x2l=6550. & x2u=6575.
x3l=3917.3 & x3u=3940.
x4l=1080. & x4u=1180.

; plot spectrum to window
set_plot,'x'
window,0,xsize=900,ysize=400,retain=2
plot,lambda86jun1,flux86jun1,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,5.5],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']',$
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda86jun1,flux86jun1,color=fsc_color('white'),noclip=0,clip=[x1l,0,x1u,13]
plots,l362narv,f362narv,color=fsc_color('red',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,13],linestyle=1,thick=3.5
xyouts,5870,4.5,'86jun',alignment=0.0,orientation=0

window,1,xsize=900,ysize=400,retain=2
plot,lambda86jun1,flux86jun1,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,13],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']', $
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda86jun1-0.2,flux86jun1,color=fsc_color('white'),noclip=0,clip=[x2l,0,x2u,13]
plots,l362narv,f362narv,color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,13],linestyle=1,thick=3.5
xyouts,6552,11,'86jun',alignment=0.0,orientation=0

;making psplots
set_plot,'ps'
device,filename='/aux/pc244a/jgroh/temp/output_opt.eps',/encapsulated,/color,bit=8,xsize=6.48,ysize=8.48,/inches
!p.multi=[0, 2, 3, 0, 0]

;1st panel, 

plot,lambda86jun1,flux86jun1,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,5.5],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']',$
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda86jun1,flux86jun1,color=fsc_color('black'),noclip=0,clip=[x1l,0,x1u,13]
plots,l362narv,f362narv,color=fsc_color('red',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,13],linestyle=1,thick=3.5
xyouts,5870,4.5,'86jun',alignment=0.0,orientation=0


;2nd panel

plot,lambda86jun1,flux86jun1,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,13],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']', $
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda86jun1-0.2,flux86jun1,color=fsc_color('black'),noclip=0,clip=[x2l,0,x2u,13]
plots,l362narv,f362narv,color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,13],linestyle=1,thick=3.5
xyouts,6552,11,'86jun',alignment=0.0,orientation=0

;3rd panel, 

plot,lambda87jan1,flux87jan1,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,5.5],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']',$
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda87jan1,flux87jan1,color=fsc_color('black'),noclip=0,clip=[x1l,0,x1u,13]
plots,l362narv,f362narv,color=fsc_color('red',!d.table_size-10), noclip=0,clip=[x1l,0,x1u,13],linestyle=1,thick=3.5
xyouts,5870,4.5,'87jan',alignment=0.0,orientation=0

;4th panel

plot,lambda87jan2-0.1,flux87jan2,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,13],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']', $
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda87jan2-0.1,flux87jan2,color=fsc_color('black'),noclip=0,clip=[x2l,0,x2u,13]
plots,l223narv,f223narv,color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,13],linestyle=1,thick=3.5
xyouts,6552,11,'87jan',alignment=0.0,orientation=0

;5th panel, 

plot,lambda87jun1,flux87jun1,xstyle=1,ystyle=1,xrange=[x3l,x3u],yrange=[0.1,1.5],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']',$
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[7,3]
plots,lambda87jun1+0.1,flux87jun1,color=fsc_color('black'),noclip=0,clip=[x3l,0,x3u,13]
plots,l362narv,f362narv/1.1,color=fsc_color('red',!d.table_size-10), noclip=0,clip=[x3l,0,x3u,13],linestyle=1,thick=3.5
xyouts,3920,0.5,'87jun',alignment=0.0,orientation=0
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 0.1) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
xyouts,lambdac[l]+0.2,1.2,'!3'+string(45B)+sobc[l],alignment=0.0,orientation=90
endif
endfor
xyouts,3933,1.2,'!3'+string(45B)+'  I.S.',alignment=0.0,orientation=90

;6th panel

plot,lambda87jun2-0.1,flux87jun2,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,13],xtitle=TEXTOIDL('\lambda')+' ['+Angstrom+']', $
ytitle='F/F!Ic',/nodata,charsize=1,XMARGIN=[5,3]
plots,lambda87jun2-0.1,flux87jun2,color=fsc_color('black'),noclip=0,clip=[x2l,0,x2u,13]
plots,l223narv,f223narv,color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,13],linestyle=1,thick=3.5
xyouts,6552,3,'87jun',alignment=0.0,orientation=0
!p.multi=[0, 0, 0, 0, 0]
device,/close
set_plot,'x'

end
