close,/all
;defines ewdata for reading, as generated by CMF_FLUX (without the first line)
ewdata='/home/groh/espectros/wr46/ewdata_91ed'  
openu,1,ewdata     ; open file without writing

;defines observed FUSE file
obsfuse='/home/groh/espectros/wr46/swp41778_merge.txt'  
openu,2,obsfuse     ; open file without writing

;defines model continuum file
modelc='/home/groh/espectros/wr46/wr46_100_car'  
openu,4,modelc    ; open file without writing

;defines model file
model='/home/groh/espectros/wr46/wr46_102b_uv.txt'  
openu,3,model    ; open file without writing

;finds the z number of depth points in model file
z=0.
while not eof(3) do begin
readf,3,linha
if linha eq '' then begin
goto,skip3
endif
z=z+1.0
skip3:
endwhile
close,3

;finds the w number of depth points in model continuum file
w=0.
while not eof(4) do begin
readf,4,linha
if linha eq '' then begin
goto,skip4
endif
w=w+1.0
skip4:
endwhile
close,4

;finds the u number of depth points in input IUE files
u=0.
while not eof(2) do begin
readf,2,linha
if linha eq '' then begin
goto,skip2
endif
u=u+1
skip2:
endwhile
close,2

;declare arrays
lambdamod=dblarr(z) & fluxmod=lambdamod & b=lambdamod 
lambdafuse=dblarr(u) & fluxfuse=lambdafuse & c=lambdafuse
lambdacont=dblarr(w) & fluxcont=lambdacont
red1=dblarr(10000) & red2=red1 & red3=red1

;reads model
openu,3,model
r=0.
for k=0.,z-1 do begin
readf,3,lambdamod1,fluxmod1
if (lambdamod1 lt 3390.0) then begin 
lambdamod[k]=lambdamod1 & fluxmod[k]=fluxmod1
r=r+1.0
endif
endfor
close,3

;reads model continuum
openu,4,modelc
s=0.
for k=0.,w-1 do begin
readf,4,lambdacont1,fluxcont1
if (lambdacont1 lt 3390.0) then begin 
lambdacont[k]=lambdacont1 & fluxcont[k]=fluxcont1
s=s+1.0
endif
endfor
close,4


;reads IUE data
openu,2,obsfuse
for j=0.,u-1 do begin
readf,2,lambdafuse1,fluxfuse1
lambdafuse[j]=lambdafuse1 & fluxfuse[j]=fluxfuse1
endfor
close,2

;scales the model flux to 4 kpc (WR46)? No already done in input file, but not in continuum
fluxmodesc=fluxmod/(4.0*4.0)/2.2
fluxcontesc=fluxcont/(4.0*4.0)

linha=''

;finds the i number of points in ewdata
i=0
while not eof(1) do begin
readf,1,linha
if linha eq '' then begin
goto,skip1
endif
i=i+1
skip1:
endwhile
close,1


;declare arrays
lambdac=dblarr(i) & cont=lambdac & ew=lambdac & sob=strarr(i) & sobc=strarr(i)
lambdac1=0. & cont1=0. & ew1=0. & sob1='A2' 

;read lambda central, continuum intensity, EW and transition ID
openu,1,ewdata
for k=0, i-1 do begin
readf,1,lambdac1,cont1,ew1,sob1
sob1=strsub(sob1,4,50)
lambdac[k]=lambdac1 & cont[k]=cont1 & ew[k]=ew1 & sob[k]=sob1
endfor
close,1

;print ew for a range of lambdas
for l=0, i-1 do begin
if (lambdac[l] gt 1170) and (lambdac[l] lt 3280) and (abs(ew[l]) gt 2.00) then begin
print,l,lambdac[l],ew[l],sob[l]
endif
endfor


;final redenning in model and continuum
minusebv=-0.29
a=3.1
fm_unred, lambdamod, fluxmodesc, minusebv, fluxmodescd, R_V = a
fm_unred, lambdacont, fluxcontesc, minusebv, fluxcontescd, R_V = a

;set plot range
x1l=1218. & x1u=1450.
x2l=1450. & x2u=1750.
x3l=2360. & x3u=3230.
x4l=1080. & x4u=1180.

; plot spectrum to window
set_plot,'x'
window,0,xsize=900,ysize=400,retain=2
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,3.0e-11],xtitle='wavelength (Angstrom)',$
ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambdamod,1.15*fluxmodescd,color=255, noclip=0,clip=[x1l,0,x1u,6.3e-11]
;plots,lambdacont,(0.55*fluxcontescd+0.0e-11),color=255, noclip=0,clip=[x1l,0,x1u,6.3e-11],linestyle=2
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 1.0) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],28.0e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq '  FeV') then begin
xyouts,lambdac[l],51.0e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  FeVI') then begin
print,lambdac[l],sobc[l]
xyouts,lambdac[l],53.0e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor


window,1,xsize=900,ysize=400,retain=2
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,3.1e-11],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambdamod,1.15*fluxmodescd,color=255, noclip=0,clip=[x2l,0,x2u,2.1e-10]
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 1.00) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],1.8e-11,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq '  FeV') then begin
xyouts,lambdac[l],1.2e-10,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  FeVI') then begin
xyouts,lambdac[l],1.5e-10,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor

window,2,xsize=900,ysize=400,retain=2
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3l,x3u],yrange=[0,0.6e-11],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)'
plots,lambdamod,1.15*fluxmodescd,color=255, noclip=0,clip=[x3l,0,x3u,3.6e-11]
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 1.00) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],0.3e-11,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq '  FeV') then begin
xyouts,lambdac[l],2.2e-11,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  FeVI') then begin
xyouts,lambdac[l],2.5e-11,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor


;making psplots
set_plot,'ps'
device,filename='/home/groh/espectros/wr46/output_iue.eps',/encapsulated,/color,bit=8,xsize=7.48,ysize=5.48,/inches
!p.multi=[0, 1, 3, 0, 0]

;1st panel, 925--1160 Angstrom
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x1l,x1u],yrange=[0,2.6e-11],xtitle='wavelength (!3'+string(197B)+')',$
ytitle='Flux (erg/s/cm^2/Angstrom)',charsize=1.5,charthick=2,color=fsc_color('black'),/nodata
plots,lambdafuse,fluxfuse,color=fsc_color('grey'),noclip=0,clip=[x1l,0,x1u,5.2e-11]
plots,lambdamod,1.15*fluxmodescd,color=fsc_color('black'), noclip=0,clip=[x1l,0,x1u,6.9e-11],thick=2
;plots,lambdacont,(0.55*fluxcontescd+0.0e-11),color=fsc_color('red'), noclip=0,clip=[x1l,0,x1u,6.9e-11],linestyle=2
;plots,[1319.41,1448.85],[5.2e-11,5.2e-11]
;plots,[1228.95,1373.67],[5.6e-11,5.6e-11]
;xyouts,1270.0,61.0e-12,'FeVI',alignment=0.5,orientation=90
;xyouts,1425.0,56.0e-12,'FeV',alignment=0.5,orientation=90
for l=0, i-1 do begin
if (lambdac[l] gt x1l) and (lambdac[l] lt x1u) and (abs(ew[l]) gt 1.0) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos+0)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],22.0e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq 'FeV') then begin
xyouts,lambdac[l],51.0e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq 'FeVI') then begin
xyouts,lambdac[l],55.0e-12,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor

;2nd panel
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x2l,x2u],yrange=[0,1.9e-11],xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)',charsize=1.5,charthick=2,/nodata
plots,lambdafuse,fluxfuse,noclip=0,clip=[x2l,0,x2u,2.4e-10],color=fsc_color('grey')
plots,lambdamod,1.15*fluxmodescd,color=fsc_color('black'), noclip=0,clip=[x2l,0,x2u,2.4e-10],thick=2
;plots,lambdacont,(0.53*fluxcontescd+0.0e-11),color=fsc_color('red'), noclip=0,clip=[x2l,0,x2u,2.4e-10],linestyle=2
plots,[1452.6,1624.07],[1.24e-10,1.24e-10]
xyouts,1530.0,1.4e-10,'FeV',alignment=0.5,orientation=90
plots,[1653.53,1675.13],[1.24e-10,1.24e-10]
xyouts,1665.0,1.4e-10,'FeV',alignment=0.5,orientation=90
for l=0, i-1 do begin
if (lambdac[l] gt x2l) and (lambdac[l] lt x2u) and (abs(ew[l]) gt 1.00) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],4,pos+0)
if ((sobc[l] ne 'FeV') && (sobc[l] ne 'FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],1.5e-11,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq 'FeV') then begin
print,lambdac[l],sobc[l]
xyouts,lambdac[l],1.2e-10,'!3'+string(45B),alignment=0.5,orientation=90
endif
;if(sobc[l] eq 'FeVI') then begin
;xyouts,lambdac[l],1.5e-10,'!3'+string(45B),alignment=0.5,orientation=90
;endif
endif
endfor

;3rd panel, lwp
plot,lambdafuse,fluxfuse,xstyle=1,ystyle=1,xrange=[x3l,x3u],yrange=[0,0.3e-11],charsize=1.5,charthick=2,xtitle='wavelength (Angstrom)', ytitle='Flux (erg/s/cm^2/Angstrom)',/nodata
plots,lambdafuse,fluxfuse,noclip=0,clip=[x3l,0,x3u,3.6e-11],color=fsc_color('grey')
plots,lambdamod,1.15*fluxmodescd,color=fsc_color('black'), noclip=0,clip=[x3l,0,x3u,3.6e-11],thick=3
;plots,lambdacont,(0.66*fluxcontescd+0.0e-11),color=fsc_color('red'), noclip=0,clip=[x3l,0,x3u,6.9e-11],linestyle=2
for l=0, i-1 do begin
if (lambdac[l] gt x3l) and (lambdac[l] lt x3u) and (abs(ew[l]) gt 1.00) then begin
pos=strpos(strtrim(sob[l],1),'(')
sobc[l]=strmid(sob[l],2,pos+2)
if ((sobc[l] ne '  FeV') && (sobc[l] ne '  FeVI')) then begin ;colocando apenas um traco nas transicoes do FeV,normal para os outros.
xyouts,lambdac[l],1.8e-12,'!3'+string(45B)+sobc[l],alignment=0.5,orientation=90
endif
if (sobc[l] eq '  FeV') then begin
xyouts,lambdac[l],2.2e-11,'!3'+string(45B),alignment=0.5,orientation=90
endif
if(sobc[l] eq '  FeVI') then begin
xyouts,lambdac[l],2.5e-11,'!3'+string(45B),alignment=0.5,orientation=90
endif
endif
endfor


!p.multi=[0, 0, 0, 0, 0]
device,/close


set_plot,'x'

end
